name: Deploy Flask App to Humanitec

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      AZURE_REGISTRY: ${{ secrets.ACR_LOGIN_SERVER }}
      IMAGE_NAME: myapp

    steps:
      # Step 1: Checkout do repositório
      - name: Checkout code
        uses: actions/checkout@v3

      # Step 2: Instalar o Python
      - name: Set up Python
        uses: actions/setup-python@v3
        with:
          python-version: 3.9

      # Step 3: Instalar dependências do Python
      - name: Install dependencies
        run: |
          pip install -r src/requirements.txt


      # Step 4: Login no Azure CLI
      - name: Azure CLI Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # Step 5: Login no Azure Container Registry (ACR)
      - name: Login to Azure Container Registry
        run: |
          echo "${{ secrets.ACR_PASSWORD }}" | docker login ${{ secrets.ACR_LOGIN_SERVER }} \
          --username ${{ secrets.ACR_USERNAME }} --password-stdin

      # Step 6: Build da imagem Docker com no-cache
      - name: Build Docker image with no-cache
        run: |
          echo "Building Docker image..."
          docker build --no-cache -t $AZURE_REGISTRY/$IMAGE_NAME:latest .
          echo "Build completed."

      # Step 7: Push da imagem Docker para o ACR
      - name: Push Docker image to Azure Container Registry
        run: |
          echo "Pushing Docker image to ACR..."
          docker push $AZURE_REGISTRY/$IMAGE_NAME:latest
          echo "Push completed."

      # Step 8: Verificar a imagem no ACR após o push
      - name: Verify image in Azure Container Registry
        run: |
          echo "Verifying image in ACR..."
          az acr login --name ${{ secrets.ACR_LOGIN_SERVER }}
          az acr repository show-tags --name ${{ secrets.ACR_LOGIN_SERVER }} --repository $IMAGE_NAME
          az acr repository show-manifests --name ${{ secrets.ACR_LOGIN_SERVER }} --repository $IMAGE_NAME

      # Step 9: Instalar o humctl CLI
      - name: Install humctl
        run: |
          echo "Baixando humctl..."
          curl -fLO https://github.com/humanitec/cli/releases/download/v0.33.0/cli_0.33.0_linux_amd64.tar.gz
          tar xvzf cli_0.33.0_linux_amd64.tar.gz
          sudo install -o root -g root -m 0755 humctl /usr/local/bin/humctl
          rm cli_0.33.0_linux_amd64.tar.gz README.md
          humctl version

      # Step 10: Login no Humanitec usando o token
      - name: Login to Humanitec
        run: humctl login --token ${{ secrets.HUMANITEC_API_TOKEN }}

      # Step 11: Validar o arquivo Score antes do deploy
      - name: Validate Score file
        env:
          HUMANITEC_ORG: labcle
          HUMANITEC_APP: api-flask
          HUMANITEC_ENV: development
        run: humctl score validate --org $HUMANITEC_ORG --app $HUMANITEC_APP --env $HUMANITEC_ENV

      # Step 12: Realizar o deploy usando Humanitec
      - name: Deploy using Humanitec
        env:
          HUMANITEC_ORG: labcle
          HUMANITEC_APP: api-flask
          HUMANITEC_ENV: development
        run: humctl score deploy --wait --org $HUMANITEC_ORG --app $HUMANITEC_APP --env $HUMANITEC_ENV
